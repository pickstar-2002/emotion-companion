# 情绪陪伴数字人 - 开发文档

## 文档信息

| 项目 | 内容 |
|------|------|
| 项目名称 | 情绪陪伴数字人 |
| 赛道 | AI 创意 / 灵感交互 |
| 方向 | 情绪陪伴数字人：全天候温暖陪伴与深度情感共鸣 |
| 文档版本 | v2.0 |
| 创建日期 | 2025-12-26 |
| 最后更新 | 2025-12-29 |

---

## 目录

1. [项目进度](#项目进度)
2. [项目简介](#项目简介)
3. [技术栈](#技术栈)
4. [技术架构](#技术架构)
5. [目录结构](#目录结构)
6. [环境配置](#环境配置)
7. [核心功能](#核心功能)
8. [密钥管理](#密钥管理)
9. [部署说明](#部署说明)

---

## 项目进度

### 已完成 ✅

| 模块 | 功能 | 状态 |
|------|------|------|
| 项目基础 | 项目初始化、配置文件 | ✅ |
| 前端 | React + Vite + TypeScript + TailwindCSS | ✅ |
| 前端状态管理 | Zustand (chatStore, emotionStore, keyStore) | ✅ |
| 前端组件 | AvatarContainer, AvatarController, ChatInput, EmotionChart | ✅ |
| 密钥管理 | KeyInputModal 弹窗，localStorage 持久化 | ✅ |
| 后端 | Express + TypeScript | ✅ |
| AI服务 | ModelScope 集成，流式对话 | ✅ |
| 情绪识别 | 关键词匹配，情绪强度分析 | ✅ |
| RAG知识库 | 220条情感陪伴数据 | ✅ |
| 快捷倾诉 | 18种预设场景 | ✅ |
| 情绪统计 | 统计分析面板 | ✅ |

---

## 项目简介

### 项目描述

基于魔珐星云3D数字人技术，打造一个能够识别用户情绪并提供全天候温暖陪伴与深度情感共鸣的情绪陪伴数字人。

### 核心功能

| 模块 | 功能描述 |
|------|----------|
| **密钥管理** | 首次访问引导用户配置密钥，支持使用内置演示密钥 |
| **情绪识别** | 通过对话内容自动识别用户情绪（开心/难过/生气/焦虑/恐惧/平静） |
| **情感对话** | 根据用户情绪状态提供相应的温暖陪伴和情感支持 |
| **快捷倾诉** | 18种预设场景（工作、学习、人际、生活等），一键表达心情 |
| **情绪统计** | 统计总记录数、今日记录、最常见情绪、各情绪平均强度 |
| **数字人驱动** | 魔珐星云3D数字人，支持情绪化语音和表情 |
| **知识库引用** | 显示AI回复参考的知识库来源，增强可信度 |

### 技术亮点

- 魔珐星云3D数字人（表情丰富，情感表达力强）
- 魔搭社区 DeepSeek-V3.2（支持思考模式，情感对话效果好）
- 密钥管理（支持自定义密钥或使用内置演示密钥）
- RAG情感陪伴知识库（220条精心设计的情感陪伴数据）
- 情绪数据持久化（localStorage自动保存）
- 流式情感对话响应（实时打字效果）

---

## 技术栈

### 前端技术栈

```yaml
框架: React 18.x + TypeScript
构建工具: Vite 5.x
状态管理: Zustand
样式方案: TailwindCSS
HTTP客户端: Fetch API
其他: 无额外UI库依赖
```

### 后端技术栈

```yaml
运行环境: Node.js 18.x
框架: Express + TypeScript
AI服务: 魔搭社区 (ModelScope)
对话模型: deepseek-ai/DeepSeek-V3.2 (支持思考模式)
其他: cors, dotenv
```

### 具身驱动SDK

```yaml
SDK名称: 魔珐星云具身驱动SDK
版本: 0.1.0-alpha.45
接入方式: JavaScript CDN
```

---

## 技术架构

### 系统架构图

```
┌────────────────────────────────────────────────────────────────────┐
│                          客户端层 (Browser)                         │
├────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │  React UI    │  │  星云SDK层   │  │  状态管理    │             │
│  │              │  │              │  │  (Zustand)   │             │
│  │ - 对话界面   │◄─┤ - 3D数字人   │◄─┤              │             │
│  │ - 快捷倾诉   │  │ - 语音合成   │  │ - 对话历史   │             │
│  │ - 情绪统计   │  │ - 情绪表情   │  │ - 情绪记录   │             │
│  │ - 密钥管理   │  │ - 动作控制   │  │ - 密钥存储   │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
└────────────────────────────────────────────────────────────────────┘
                                  │
                                  │ HTTP/WebSocket
                                  ▼
┌────────────────────────────────────────────────────────────────────┐
│                          服务端层 (Node.js)                         │
├────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │  API服务     │  │  AI服务      │  │  情绪识别     │             │
│  │  (Express)   │  │  (魔搭)      │  │  (情感分析)   │             │
│  │              │  │              │  │              │             │
│  │ - /chat      │─►│ - 情感对话   │◄─│ - 情绪分析   │             │
│  │ - /emotion   │  │ - 流式响应   │  │ - 强度计算   │             │
│  │              │  │ - 思考模式   │  │              │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
│                                  │                                     │
│                                  ▼                                     │
│  ┌──────────────┐                                                │
│  │  RAG检索    │                                                │
│  │  220条数据  │                                                │
│  └──────────────┘                                                │
└────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌────────────────────────────────────────────────────────────────────┐
│                          数据存储层                                 │
├────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐                             │
│  │  localStorage │  │  文件系统     │                             │
│  │  - 对话历史  │  │  (知识库)    │                             │
│  │  - 情绪记录  │  │  - 情绪知识   │                             │
│  │  - API密钥   │  │  - 共情回应   │                             │
│  └──────────────┘  │  - 安慰支持   │                             │
│                    │  - 激励鼓励   │                             │
│                    └──────────────┘                             │
└────────────────────────────────────────────────────────────────────┘
```

---

## 目录结构

```
emotion-companion/
├── src/                         # 源代码目录
│   ├── client/                  # 前端代码 (React + TypeScript)
│   │   ├── components/
│   │   │   ├── Avatar/
│   │   │   │   ├── AvatarController.ts      # SDK控制器
│   │   │   │   └── AvatarContainer.tsx      # 数字人容器（含连接管理）
│   │   │   ├── Chat/
│   │   │   │   └── ChatInput.tsx              # 对话输入组件
│   │   │   ├── Emotion/
│   │   │   │   └── EmotionChart.tsx          # 情绪图表组件
│   │   │   └── Common/
│   │   │       └── KeyInputModal.tsx         # 密钥输入弹窗
│   │   ├── store/
│   │   │   ├── emotionStore.ts              # 情绪状态管理
│   │   │   ├── chatStore.ts                 # 对话状态管理
│   │   │   └── keyStore.ts                  # API密钥管理
│   │   ├── services/
│   │   │   └── chatService.ts                # 前端API服务
│   │   ├── App.tsx                           # 主应用组件
│   │   └── main.tsx                          # 入口文件
│   │
│   ├── server/                 # 后端代码 (Node.js + TypeScript)
│   │   ├── routes/
│   │   │   ├── chat.routes.ts                # 对话路由
│   │   │   ├── emotion.routes.ts             # 情绪分析路由
│   │   │   └── diary.routes.ts               # 日记路由
│   │   ├── services/
│   │   │   ├── chatService.ts                # 对话处理服务
│   │   │   ├── modelscopeService.ts          # 魔搭AI服务
│   │   │   ├── ragService.ts                 # RAG检索服务
│   │   │   └── emotionService.ts             # 情绪识别服务
│   │   ├── app.ts                            # Express应用入口
│   │   └── main.ts                           # 后端入口
│   │
│   └── data/                   # 知识库数据
│       └── knowledge/
│           ├── emotion.json                  # 情绪陪伴知识库 (55条)
│           ├── empathy.json                  # 共情回应知识库 (55条)
│           ├── comfort.json                  # 安慰支持知识库 (55条)
│           └── motivation.json                # 激励鼓励知识库 (55条)
│
├── public/                      # 静态资源
├── api.txt                      # API密钥参考文件
├── package.json                 # 项目配置
├── vite.config.ts              # Vite配置
├── tsconfig.json               # TypeScript配置
├── tsconfig.server.json        # TypeScript配置 (后端)
├── tailwind.config.js          # TailwindCSS配置
├── postcss.config.js           # PostCSS配置
├── .env                         # 前端环境变量
├── .env.server                  # 后端环境变量
├── CLAUDE.md                    # 开发文档（本文件）
└── README.md                    # 项目说明
```

---

## 环境配置

### 安装依赖

```bash
# 安装所有依赖
npm install
```

### 前端环境变量

**.env** (已弃用 - 现在使用密钥输入弹窗)

```bash
# 以下配置已通过密钥输入弹窗管理
# VITE_API_BASE_URL=/api
# VITE_APP_ID=your_app_id
# VITE_APP_SECRET=your_app_secret
```

### 后端环境变量

**.env.server**

```bash
# 服务器配置
PORT=5176
NODE_ENV=development

# 魔搭AI配置
MODELSCOPE_API_KEY=ms-85ed98e9-1a8e-41e5-8215-ee563559d069
MODELSCOPE_MODEL=deepseek-ai/DeepSeek-V3.2
MODELSCOPE_EMBEDDING_MODEL=Qwen/Qwen3-Embedding-8B
```

---

## 核心功能

### 1. 密钥管理

首次访问时自动弹出密钥配置窗口，支持：
- **使用内置演示密钥**：快速体验功能
- **自定义密钥**：用户输入自己的 API 密钥

密钥保存在 localStorage 中，可随时通过右上角"设置"按钮重新配置。

**文件位置**：
- `src/client/store/keyStore.ts` - 密钥状态管理
- `src/client/components/Common/KeyInputModal.tsx` - 密钥输入弹窗

### 2. 数字人连接管理

手动控制数字人连接状态，避免不必要的积分消耗：
- **未连接**：显示连接按钮和说明
- **连接中**：显示加载动画
- **已连接**：显示断开连接按钮
- **连接失败**：显示错误信息和重试按钮

**文件位置**：
- `src/client/components/Avatar/AvatarContainer.tsx`

### 3. 快捷倾诉

18种预设场景，覆盖工作、学习、人际关系、生活日常等多个方面：

| 分类 | 场景 |
|------|------|
| 工作 | 工作压力大、被领导批评、加班太累、升职加薪 |
| 学习 | 考试紧张、学习遇到困难、拿到好成绩、毕业迷茫 |
| 人际 | 和朋友的矛盾、感情问题、家庭矛盾、感到孤独 |
| 生活 | 失眠困扰、经济压力、搬家烦恼、身体不适 |
| 情绪 | 无缘无故烦躁、想找人聊天 |

### 4. 情绪识别

基于关键词匹配的情绪识别算法，支持6种情绪类型：

| 情绪 | 关键词示例 | 强度范围 |
|------|-----------|---------|
| happy | 开心、高兴、快乐、幸福、哈哈 | 0-1 |
| sad | 难过、伤心、悲伤、痛苦 | 0-1 |
| angry | 生气、愤怒、火大、恼火 | 0-1 |
| anxious | 焦虑、担心、紧张、不安 | 0-1 |
| fear | 害怕、恐惧、恐慌 | 0-1 |
| normal | 默认状态 | 0 |

### 5. 情绪统计

显示用户近7天的情绪数据分析：

- **总记录数**：情绪记录总数
- **今日记录**：今天的对话记录数
- **最常见情绪**：出现频率最高的情绪
- **各情绪平均强度**：每种情绪的平均强度百分比
- **总体情绪强度**：综合情绪强度指数

---

## 密钥管理

### 内置演示密钥

项目内置了演示密钥（保存在 `keyStore.ts` 中）：

```typescript
const DEFAULT_KEYS: ApiKeys = {
  modelscopeApiKey: 'ms-85ed98e9-1a8e-41e5-8215-ee563559d069',
  xingyunAppId: 'b70a23de5fe34312a5a2ac0e885b5118',
  xingyunAppSecret: '26d0815b4c7d4e3db207c3ee221dbf21'
};
```

### 密钥存储流程

```
用户首次访问
    │
    ▼
┌─────────────────┐
│  KeyInputModal   │
│  - 选择使用内置密钥│
│  - 或输入自定义密钥│
└────────┬────────┘
         │
         ▼
    localStorage
         │
         ▼
┌─────────────────┐
│   keyStore      │
│  - getXingyunAppId()
│  - getXingyunAppSecret()
│  - getModelScopeKey()
└─────────────────┘
```

### 密钥传递

- **前端 → 后端**：通过 HTTP 请求体传递 `apiKey` 字段
- **AvatarContainer**：直接从 keyStore 读取密钥初始化数字人

---

## 部署说明

### 开发环境启动

```bash
# 启动前端和后端
npm run dev

# 前端: http://localhost:5173
# 后端: http://localhost:5176
```

### 生产环境构建

```bash
# 构建前端
npm run build

# 启动后端
npx tsx src/server/main.ts
```

### 环境要求

- Node.js >= 18.x
- npm >= 9.x

---

## 附录

### SDK配置

| 配置项 | 值 |
|--------|-----|
| SDK版本 | 0.1.0-alpha.45 |
| CDN地址 | https://media.youyan.xyz/youling-lite-sdk/index.umd.0.1.0-alpha.45.js |

### API密钥获取

- **魔搭社区**：https://modelscope.cn/ （免费额度）
- **魔珐星云**：https://nebula.xingyun3d.com/ （需要注册账号）

### 知识库统计

| 知识库 | 条目数 |
|--------|-------|
| emotion 情绪陪伴 | 55 |
| empathy 共情回应 | 55 |
| comfort 安慰支持 | 55 |
| motivation 激励鼓励 | 55 |
| **总计** | **220** |

---

*文档版本: v2.0 | 最后更新: 2025-12-29*
